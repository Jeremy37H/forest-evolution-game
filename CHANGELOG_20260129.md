# 🌲 森林進化遊戲 (Forest Evolution) - 開發日誌

**日期**：2026-01-29
**目標**：修復競標顯示異常、優化管理員體驗、調整遊戲平衡

---

## 🚀 重大更新 (Highlights)

### 1. ⚖️ 屬性分配機制重構

- **修改內容**：將原本的「找人數最少」邏輯，改為 **「三元平衡分配法」**。
- **規則**：
  1. 優先將總人數平均分配給 **[火、水、木]** 三大屬性。
  2. 若人數無法被 3 整除，餘數分配給 **[雷]** 屬性。
- **影響範圍**：新加入遊戲的玩家 (Server 邏輯)。

### 2. ⚔️ 競標系統緊急救援

- **新增功能**：管理員面板新增 **「⚠ 強制跳過所有競標」** 按鈕。
  - 解決因計時器不同步導致全體玩家卡在競標畫面的問題。
- **UI 優化**：競標視窗右上角新增 **「✖ (登出並離開)」** 按鈕。
  - 樣式：懸浮透明背景，紅色 hover 特效。
  - 解決管理員誤入玩家競標視窗無法脫身的問題。

### 3. 👮‍♂️ 管理員體驗優化

- **身分鎖定**：現在進入管理員介面會自動寫入 `localStorage` 標記 (`forestIsAdmin`)。
- **防呆機制**：按下 **F5** 重新整理時，系統會優先檢查標記並導回管理員面板，不再自動登入玩家角色。

---

## 🐛 錯誤修復 (Bug Fixes)

### 🕵️‍♂️ 競標「神秘玩家」修正

- **問題**：競標時最高出價者顯示為「神秘玩家」。
- **修復**：
  - **後端**：`getEnrichedGameData` 補上 `playerId` 與 `playerCode` 欄位。
  - **前端**：`getBidderName` 增加 Fallback 機制，若對應不到 ID 則直接顯示傳回的名字。

### 📜 技能說明消失修正 (如：折翅、噴墨)

- **問題**：自訂技能池時，技能說明顯示為 "true" 或空白。
- **修復**：後端 `startAuction` 邏輯改為 **全域技能檢索**，即使自訂技能跨越不同回合，也能正確撈取描述文字。

### 💥 伺服器穩定性

- **問題**：`gameRoutes.js` 變數重複宣告 (`existingPlayers`, `assignedAttribute`) 導致崩潰。
- **修復**：移除殘留的舊邏輯代碼，確保變數宣告唯一。

### 🖥️ 管理員控制台佈局修正 (Admin Console Layout)

- **問題**：管理員面板的玩家列表與排名視窗格式混亂，文字擠壓成一團。
- **修復**：
  - **容器擴展**：修改 `App.vue` 使管理員模式下 `#game-container` 寬度可自動擴展至 1000px。
  - **排名清單優化**：重寫 `.ranking-list` 樣式，增加間距、對齊與標籤化。
  - **玩家卡片現代化**：優化 `.player-admin-card` 陰影、圓角、與屬性徽章 (Glow 效果)。
  - **按鍵衝突修正**：確保 mini-buttons 在全域按鈕樣式下仍維持正確尺寸。

### 4. 🎨 管理員面板視覺微調 (Admin Panel Visual Polish)

- **按鈕樣式回歸**：將「進入遊戲」與「刪除遊戲」按鈕恢復為原本的垂直文字設計，並採用 **並排顯示 (Side-by-Side)**，同時補上綠色與紅色的背景識別色 (Green/Red)。
- **列表佈局優化**：調整遊戲列表 Grid 資訊欄位順序，並改為 **Auto-width** 欄位設計。
  - 將「狀態」與「時間」欄位設為 **置右對齊 (Right Align)**，並增加與按鈕區的間距 (`gap: 15px`)，徹底解決文字擠壓與視覺不平衡的問題。
  - **列表對齊修正**：
    1. 強制資訊區塊填滿剩餘空間 (`flex-grow: 1`)，確保所有卡片的文字右緣整齊劃一。
    2. 設定左側欄位最小固定寬度 (`minmax(110px, ...)`)，解決因「2/4」與「21/22」字數差異造成上下排文字起始點輕微錯位的問題。
  - **時間顯示優化**：將原本僅顯示時間的格式改為 **完整日期 + 24小時制** (e.g. `2026/1/29 15:30`)，並 **移除秒數**，讓介面更簡潔易讀。
- **文案修正**：將「建立全效戰局」按鈕文字簡化回原本的「建立戰局」。
- **技能設定紐優化**：將原本的齒輪圖示 (⚙️) 改為 **書本圖示 (📖)**，並以絕對定位放置於最右側，確保「玩家人數」輸入框維持 **完美置中**，不受圖示擠壓影響。
- **介面間距收斂**：大幅減少「玩家人數」與「建立戰局」按鈕之間的空白行高度，讓建立區域看起來更緊湊精緻。
- **返回按鈕可視性修復**：修復「返回主導頁」按鈕因背景色過淺導致文字無法辨識的問題，現在採用 **藍灰色 (#607d8b)** 背景，確保清晰可見；同時修正按鈕文字為「返回首頁」。
- **剔除按鈕簡約化**：移除玩家列表中的剔除 (X) 按鈕的預設背景色（改為 **透明**），僅保留深紅色文字，減少視覺干擾。當滑鼠懸停時才會顯示淺粉紅底色，保持操作提示性。

---

## 📂 檔案變更清單 (Files Modified)

| 檔案路徑 | 類型 | 說明 |
| :--- | :--- | :--- |
| `server/services/gameService.js` | Backend | 修正競標資料欄位、技能描述查表邏輯 |
| `server/routes/gameRoutes.js` | Backend | 重寫屬性分配邏輯、新增強制跳過路由、清理重複變數 |
| `client/src/App.vue` | Frontend | 競標 UI (Close Btn)、F5 身分判斷、管理員寬度控制 |
| `client/src/components/AdminPanel.vue` | Frontend | 新增跳過按鈕、身分鎖定邏輯、佈局樣式重構 |
| `.agentrules` | Config | 建立 Token 節流與開發效能規範 |
| `server/config/gameConstants.js` | Config | (檢查確認無誤，未修改) |

---

> *"寫這段程式碼的時候，覺得自己像是森林裡的園丁，一邊修剪多餘的枝葉（舊代碼），一邊確保每棵樹（屬性）都長得一樣高。" — Antigravity Agent*
